!function(){"use strict";var t,e=function(){var t,e,i,n=arguments.length,o=arguments[0]||{};for("object"!=typeof o&&"function"!=typeof o&&(o={}),1==n&&(o=this,t--),t=1;t<n;t++)for(i in e=arguments[t])Object.prototype.hasOwnProperty.call(e,i)&&(o[i]=e[i]);return o},i=function(t){return"function"==typeof t&&"number"!=typeof t.nodeType},n=function(t,i){this.$element=t,this.options=e({},n.DEFAULTS,i),this.$element.style.position="relative",this.$element.style.width=this.options.width+"px",this.$element.style.margin="0",this.init()};n.VERSION="1.0",n.Author="argo@163.com",n.DEFAULTS={width:280,height:155,PI:Math.PI,sliderL:42,sliderR:9,offset:5,loadingText:"正在加载中...",failedText:"再试一次",barText:"向右滑动填充拼图",repeatIcon:"fa fa-repeat",maxLoadCount:3,localImages:function(){return"images/Pic"+Math.round(4*Math.random())+".jpg"},verify:function(t,e){var i=!1;return $.ajax({url:e,data:{datas:JSON.stringify(t)},dataType:"json",type:"post",async:!1,success:function(t){i=JSON.stringify(t),console.log("返回结果："+i)}}),i},remoteUrl:null},window.sliderCaptcha=function(t){var e=document.getElementById(t.id);return new n(e,"object"==typeof t&&t)},window.sliderCaptcha.Constructor=n,(t=n.prototype).init=function(){this.initDOM(),this.initImg(),this.bindEvents()},t.initDOM=function(){var t,n,o=function(t,e){var i=document.createElement(t);return i.className=e,i},s=function(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}(this.options.width-2,this.options.height),r=s.cloneNode(!0),a=o("div","sliderContainer"),l=o("i","refreshIcon "+this.options.repeatIcon),d=o("div","sliderMask"),c=o("div","sliderbg"),h=o("div","slider"),p=o("i","fa fa-arrow-right sliderIcon"),u=o("span","sliderText");r.className="block",u.innerHTML=this.options.barText,(t=this.$element).appendChild(s),t.appendChild(l),t.appendChild(r),h.appendChild(p),d.appendChild(h),a.appendChild(c),a.appendChild(d),a.appendChild(u),t.appendChild(a),n={canvas:s,block:r,sliderContainer:a,refreshIcon:l,slider:h,sliderMask:d,sliderIcon:p,text:u,canvasCtx:s.getContext("2d"),blockCtx:r.getContext("2d")},i(Object.assign)?Object.assign(this,n):e(this,n)},t.initImg=function(){var t,e=this,n=window.navigator.userAgent.indexOf("Trident")>-1,o=this.options.sliderL+2*this.options.sliderR+3,s=function(t,i){var o=e.options.sliderL,s=e.options.sliderR,r=e.options.PI,a=e.x,l=e.y;t.beginPath(),t.moveTo(a,l),t.arc(a+o/2,l-s+2,s,.72*r,2.26*r),t.lineTo(a+o,l),t.arc(a+o+s-2,l+o/2,s,1.21*r,2.78*r),t.lineTo(a+o,l+o),t.lineTo(a,l+o),t.arc(a+s-2,l+o/2,s+.4,2.76*r,1.24*r,!0),t.lineTo(a,l),t.lineWidth=2,t.fillStyle="rgba(255, 255, 255, 0.7)",t.strokeStyle="rgba(255, 255, 255, 0.7)",t.stroke(),t[i](),t.globalCompositeOperation=n?"xor":"destination-over"},r=function(t,e){return Math.round(Math.random()*(e-t)+t)},a=new Image;a.crossOrigin="Anonymous",t=0,a.onload=function(){e.x=r(o+10,e.options.width-(o+10)),e.y=r(10+2*e.options.sliderR,e.options.height-(o+10)),s(e.canvasCtx,"fill"),s(e.blockCtx,"clip"),e.canvasCtx.drawImage(a,0,0,e.options.width-2,e.options.height),e.blockCtx.drawImage(a,0,0,e.options.width-2,e.options.height);var t=e.y-2*e.options.sliderR-1,i=e.blockCtx.getImageData(e.x-3,t,o,o);e.block.width=o,e.blockCtx.putImageData(i,0,t+1),e.text.textContent=e.text.getAttribute("data-text")},a.onerror=function(){if(t++,"file:"===window.location.protocol&&(t=e.options.maxLoadCount,console.error("can't load pic resource file from File protocal. Please try http or https")),t>=e.options.maxLoadCount)return e.text.textContent="加载失败",void e.classList.add("text-danger");a.src=e.options.localImages()},a.setSrc=function(){var o,s="";t=0,e.text.classList.remove("text-danger"),i(e.options.setSrc)&&(s=e.options.setSrc()),s&&""!==s||(s="https://picsum.photos/"+e.options.width+"/"+e.options.height+"/?image="+Math.round(20*Math.random())),n?((o=new XMLHttpRequest).onloadend=function(t){var e=new FileReader;e.readAsDataURL(t.target.response),e.onloadend=function(t){a.src=t.target.result}},o.open("GET",s),o.responseType="blob",o.send()):a.src=s},a.setSrc(),this.text.setAttribute("data-text",this.options.barText),this.text.textContent=this.options.loadingText,this.img=a},t.clean=function(){this.canvasCtx.clearRect(0,0,this.options.width,this.options.height),this.blockCtx.clearRect(0,0,this.options.width,this.options.height),this.block.width=this.options.width},t.bindEvents=function(){var t=this;this.$element.addEventListener("selectstart",(function(){return!1})),this.refreshIcon.addEventListener("click",(function(){t.text.textContent=t.options.barText,t.reset(),i(t.options.onRefresh)&&t.options.onRefresh.call(t.$element)}));var e,n,o=[],s=!1,r=function(i){t.text.classList.contains("text-danger")||(e=i.clientX||i.touches[0].clientX,n=i.clientY||i.touches[0].clientY,s=!0)},a=function(i){var r;if(!s)return!1;var a=i.clientX||i.touches[0].clientX,l=i.clientY||i.touches[0].clientY,d=a-e,c=l-n;if(d<0||d+40>t.options.width)return!1;t.slider.style.left=d-1+"px",r=(t.options.width-60)/(t.options.width-40)*d,t.block.style.left=r+"px",t.sliderContainer.classList.add("sliderContainer_active"),t.sliderMask.style.width=d+4+"px",o.push(Math.round(c))},l=function(n){var r;if(!s||(s=!1,(n.clientX||n.changedTouches[0].clientX)===e))return!1;t.sliderContainer.classList.remove("sliderContainer_active"),t.trail=o,(r=t.verify()).spliced&&r.verified?(t.sliderContainer.classList.add("sliderContainer_success"),i(t.options.onSuccess)&&t.options.onSuccess.call(t.$element)):(t.sliderContainer.classList.add("sliderContainer_fail"),i(t.options.onFail)&&t.options.onFail.call(t.$element),setTimeout((function(){t.text.innerHTML=t.options.failedText,t.reset()}),1e3))};this.slider.addEventListener("mousedown",r),this.slider.addEventListener("touchstart",r),document.addEventListener("mousemove",a),document.addEventListener("touchmove",a),document.addEventListener("mouseup",l),document.addEventListener("touchend",l),document.addEventListener("mousedown",(function(){return!1})),document.addEventListener("touchstart",(function(){return!1})),document.addEventListener("swipe",(function(){return!1}))},t.verify=function(){var t=this.trail,e=parseInt(this.block.style.left),i=!1;if(null!==this.options.remoteUrl)i=this.options.verify(t,this.options.remoteUrl);else{var n=function(t,e){return t+e},o=t.reduce(n)/t.length,s=t.map((function(t){return t-o}));i=0!==Math.sqrt(s.map((function(t){return t*t})).reduce(n)/t.length)}return{spliced:Math.abs(e-this.x)<this.options.offset,verified:i}},t.reset=function(){this.sliderContainer.classList.remove("sliderContainer_fail"),this.sliderContainer.classList.remove("sliderContainer_success"),this.slider.style.left=0,this.block.style.left=0,this.sliderMask.style.width=0,this.clean(),this.text.setAttribute("data-text",this.text.textContent),this.text.textContent=this.options.loadingText,this.img.setSrc()}}();